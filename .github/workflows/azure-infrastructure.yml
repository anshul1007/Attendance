name: Setup Azure Infrastructure

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      environment:
        description: 'Environment (prod, dev, staging)'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - dev
          - staging
      location:
        description: 'Azure Region'
        required: true
        default: 'westeurope'
        type: choice
        options:
          - westeurope
          - northeurope
          - germanywestcentral
          - francecentral
          - uksouth
          - eastus
          - westus2

jobs:
  create-infrastructure:
    runs-on: ubuntu-latest
    
    steps:
    - name: üîÑ Checkout code
      uses: actions/checkout@v4

    - name: üîê Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ÔøΩ Register Azure Resource Providers
      run: |
        echo "Registering required Azure resource providers..."
        
        # Register all required providers
        az provider register --namespace Microsoft.Sql --wait
        az provider register --namespace Microsoft.Web --wait
        az provider register --namespace Microsoft.Storage --wait
        az provider register --namespace Microsoft.Insights --wait
        
        # Verify registration status
        echo "‚úÖ Microsoft.Sql: $(az provider show --namespace Microsoft.Sql --query "registrationState" -o tsv)"
        echo "‚úÖ Microsoft.Web: $(az provider show --namespace Microsoft.Web --query "registrationState" -o tsv)"
        echo "‚úÖ Microsoft.Storage: $(az provider show --namespace Microsoft.Storage --query "registrationState" -o tsv)"
        echo "‚úÖ Microsoft.Insights: $(az provider show --namespace Microsoft.Insights --query "registrationState" -o tsv)"
        
        echo "‚úÖ All resource providers registered successfully"

    - name:  Create Resource Group
      run: |
        ENV="${{ github.event.inputs.environment }}"
        RESOURCE_GROUP="vermillion-attendance-${ENV}-rg"
        
        echo "Creating Resource Group: $RESOURCE_GROUP"
        az group create \
          --name $RESOURCE_GROUP \
          --location ${{ github.event.inputs.location }}
        
        echo "RESOURCE_GROUP=$RESOURCE_GROUP" >> $GITHUB_ENV
        echo "‚úÖ Resource Group created: $RESOURCE_GROUP"

    - name: üíæ Create Azure SQL Server
      run: |
        ENV="${{ github.event.inputs.environment }}"
        SQL_SERVER_NAME="vermillion-sql-${ENV}"
        SQL_ADMIN_USER="sqladmin"
        SQL_ADMIN_PASSWORD="${{ secrets.SQL_ADMIN_PASSWORD_PROD }}"
        LOCATION="${{ github.event.inputs.location }}"
        SQL_CREATED=false
        
        echo "Checking if SQL Server already exists: $SQL_SERVER_NAME"
        
        # Check if SQL server already exists in current resource group
        if az sql server show --name $SQL_SERVER_NAME --resource-group ${{ env.RESOURCE_GROUP }} 2>/dev/null; then
          echo "‚úÖ SQL Server already exists in this resource group: $SQL_SERVER_NAME"
          EXISTING_LOCATION=$(az sql server show --name $SQL_SERVER_NAME --resource-group ${{ env.RESOURCE_GROUP }} --query "location" -o tsv)
          echo "üìç Using existing SQL Server in location: $EXISTING_LOCATION"
          LOCATION=$EXISTING_LOCATION
          SQL_CREATED=true
        else
          # Check if SQL server exists globally (in another resource group)
          EXISTING_SERVER=$(az sql server list --query "[?name=='$SQL_SERVER_NAME'].{name:name,resourceGroup:resourceGroup,location:location}" -o json 2>/dev/null)
          
          if [ "$EXISTING_SERVER" != "[]" ] && [ ! -z "$EXISTING_SERVER" ]; then
            EXISTING_RG=$(echo $EXISTING_SERVER | jq -r '.[0].resourceGroup')
            EXISTING_LOC=$(echo $EXISTING_SERVER | jq -r '.[0].location')
            echo "‚ö†Ô∏è  WARNING: SQL Server '$SQL_SERVER_NAME' already exists in resource group: $EXISTING_RG"
            echo "üìç Location: $EXISTING_LOC"
            echo ""
            echo "‚ùå ERROR: Cannot create SQL Server with the same name in a different resource group!"
            echo ""
            echo "üîß SOLUTION OPTIONS:"
            echo "1. Delete the existing SQL Server from resource group: $EXISTING_RG"
            echo "   Run: az sql server delete --name $SQL_SERVER_NAME --resource-group $EXISTING_RG --yes"
            echo ""
            echo "2. Or delete the old resource group entirely if it's no longer needed:"
            echo "   Run: az group delete --name $EXISTING_RG --yes"
            echo ""
            echo "3. Or change the environment name to use a different SQL server name"
            exit 1
          fi
          
          echo "Creating new SQL Server: $SQL_SERVER_NAME in region: $LOCATION"
          
          # Try primary location first
          if az sql server create \
            --name $SQL_SERVER_NAME \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --location $LOCATION \
            --admin-user $SQL_ADMIN_USER \
            --admin-password $SQL_ADMIN_PASSWORD 2>&1; then
            echo "‚úÖ SQL Server created in $LOCATION: $SQL_SERVER_NAME"
            SQL_CREATED=true
          else
            echo "‚ö†Ô∏è Failed to create SQL Server in $LOCATION, trying alternative regions..."
            
            # Try alternative European regions
            for ALT_LOCATION in "northeurope" "francecentral" "uksouth" "germanywestcentral" "swedencentral" "eastus" "westus2"; do
              echo "Trying $ALT_LOCATION..."
              
              if az sql server create \
                --name $SQL_SERVER_NAME \
                --resource-group ${{ env.RESOURCE_GROUP }} \
                --location $ALT_LOCATION \
                --admin-user $SQL_ADMIN_USER \
                --admin-password $SQL_ADMIN_PASSWORD 2>&1; then
                echo "‚úÖ SQL Server created in $ALT_LOCATION: $SQL_SERVER_NAME"
                LOCATION=$ALT_LOCATION
                SQL_CREATED=true
                break
              else
                echo "‚ùå Failed in $ALT_LOCATION, trying next region..."
              fi
            done
          fi
        fi
        
        # Verify SQL Server exists or was created
        if [ "$SQL_CREATED" = false ]; then
          echo ""
          echo "‚ùå ERROR: Failed to create SQL Server in all attempted regions!"
          echo ""
          echo "üîç Possible reasons:"
          echo "1. SQL Server name '$SQL_SERVER_NAME' already exists in another resource group"
          echo "2. Capacity issues in all attempted regions"
          echo "3. Azure subscription restrictions or quotas"
          echo ""
          echo "üîß Troubleshooting steps:"
          echo "1. Check if server exists: az sql server list --query \"[?name=='$SQL_SERVER_NAME']\""
          echo "2. Try deleting old resource groups: az group list --query \"[?starts_with(name, 'vermillion')].name\""
          echo "3. Contact Azure support if issue persists"
          exit 1
        fi
        
        echo "SQL_SERVER_NAME=$SQL_SERVER_NAME" >> $GITHUB_ENV
        echo "SQL_LOCATION=$LOCATION" >> $GITHUB_ENV
        echo "SQL_ADMIN_USER=$SQL_ADMIN_USER" >> $GITHUB_ENV
        echo "ENVIRONMENT=$ENV" >> $GITHUB_ENV
        echo "‚úÖ SQL Server successfully configured: $SQL_SERVER_NAME in region: $LOCATION"

    - name: üî• Configure SQL Server Firewall
      run: |
        # Allow Azure services (create or update)
        az sql server firewall-rule create \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --server ${{ env.SQL_SERVER_NAME }} \
          --name AllowAzureServices \
          --start-ip-address 0.0.0.0 \
          --end-ip-address 0.0.0.0 \
          2>/dev/null || az sql server firewall-rule update \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --server ${{ env.SQL_SERVER_NAME }} \
          --name AllowAzureServices \
          --start-ip-address 0.0.0.0 \
          --end-ip-address 0.0.0.0
        
        echo "‚úÖ Firewall rule configured"

    - name: üíø Create SQL Database
      run: |
        # Check if database already exists
        if az sql db show --name AttendanceDB --server ${{ env.SQL_SERVER_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} 2>/dev/null; then
          echo "‚úÖ Database already exists: AttendanceDB"
        else
          echo "Creating database: AttendanceDB"
          az sql db create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --server ${{ env.SQL_SERVER_NAME }} \
            --name AttendanceDB \
            --service-objective Basic \
            --backup-storage-redundancy Local \
            --no-wait
          echo "‚úÖ Database creation started"
        fi

    - name: üåê Create App Service Plan
      run: |
        ENV="${{ github.event.inputs.environment }}"
        APP_PLAN_NAME="vermillion-attendance-plan-${ENV}"
        
        # Check if App Service Plan already exists
        if az appservice plan show --name $APP_PLAN_NAME --resource-group ${{ env.RESOURCE_GROUP }} 2>/dev/null; then
          echo "‚úÖ App Service Plan already exists: $APP_PLAN_NAME"
        else
          echo "Creating App Service Plan: $APP_PLAN_NAME"
          az appservice plan create \
            --name $APP_PLAN_NAME \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --location ${{ env.SQL_LOCATION }} \
            --sku B1 \
            --is-linux
          echo "‚úÖ App Service Plan created: $APP_PLAN_NAME"
        fi
        
        echo "APP_PLAN_NAME=$APP_PLAN_NAME" >> $GITHUB_ENV

    - name: üöÄ Create Web App (Backend)
      run: |
        ENV="${{ github.event.inputs.environment }}"
        WEBAPP_NAME="vermillion-api-${ENV}"
        
        # Check if Web App already exists
        if az webapp show --name $WEBAPP_NAME --resource-group ${{ env.RESOURCE_GROUP }} 2>/dev/null; then
          echo "‚úÖ Web App already exists: $WEBAPP_NAME"
        else
          echo "Creating Web App: $WEBAPP_NAME"
          az webapp create \
            --name $WEBAPP_NAME \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --plan ${{ env.APP_PLAN_NAME }} \
            --runtime "DOTNETCORE:8.0"
          echo "‚úÖ Web App created: $WEBAPP_NAME"
        fi
        
        echo "WEBAPP_NAME=$WEBAPP_NAME" >> $GITHUB_ENV

    - name: üîó Configure Connection String
      run: |
        CONNECTION_STRING="Server=tcp:${{ env.SQL_SERVER_NAME }}.database.windows.net,1433;Initial Catalog=AttendanceDB;User ID=sqladmin;Password=${{ secrets.SQL_ADMIN_PASSWORD_PROD }};Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
        
        az webapp config connection-string set \
          --name ${{ env.WEBAPP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --connection-string-type SQLAzure \
          --settings DefaultConnection="$CONNECTION_STRING"
        
        echo "‚úÖ Connection string configured"

    - name: ‚öôÔ∏è Configure App Settings
      run: |
        az webapp config appsettings set \
          --name ${{ env.WEBAPP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --settings \
            ASPNETCORE_ENVIRONMENT="Production" \
            WEBSITE_RUN_FROM_PACKAGE="1"
        
        echo "‚úÖ App settings configured"

    - name: üì± Create Static Web App (Frontend)
      run: |
        ENV="${{ github.event.inputs.environment }}"
        STATIC_APP_NAME="vermillion-web-${ENV}"
        
        # Check if Static Web App already exists
        if az staticwebapp show --name $STATIC_APP_NAME --resource-group ${{ env.RESOURCE_GROUP }} 2>/dev/null; then
          echo "‚úÖ Static Web App already exists: $STATIC_APP_NAME"
        else
          echo "Creating Static Web App: $STATIC_APP_NAME"
          az staticwebapp create \
            --name $STATIC_APP_NAME \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --location ${{ github.event.inputs.location }} \
            --sku Free
          echo "‚úÖ Static Web App created: $STATIC_APP_NAME"
        fi
        
        echo "STATIC_APP_NAME=$STATIC_APP_NAME" >> $GITHUB_ENV

    - name: üìù Get Deployment URLs
      run: |
        BACKEND_URL="https://${{ env.WEBAPP_NAME }}.azurewebsites.net"
        STATIC_APP_URL=$(az staticwebapp show \
          --name ${{ env.STATIC_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query "defaultHostname" -o tsv)
        
        echo "=========================================="
        echo "‚úÖ INFRASTRUCTURE CREATED SUCCESSFULLY!"
        echo "=========================================="
        echo ""
        echo "üåç Environment: ${{ github.event.inputs.environment }}"
        echo "ÔøΩ Resource Group: ${{ env.RESOURCE_GROUP }}"
        echo "ÔøΩüì± Frontend URL: https://$STATIC_APP_URL"
        echo "üîß Backend URL: $BACKEND_URL"
        echo "üíæ SQL Server: ${{ env.SQL_SERVER_NAME }}.database.windows.net"
        echo "üåç SQL Location: ${{ env.SQL_LOCATION }}"
        echo "üåç Primary Location: ${{ github.event.inputs.location }}"
        echo ""
        echo "=========================================="
        echo "üìã NEXT STEPS:"
        echo "=========================================="
        echo ""
        echo "1. Add these secrets to your GitHub repository:"
        echo "   - Go to: Settings ‚Üí Secrets and variables ‚Üí Actions"
        echo ""
        echo "2. Add AZURE_WEBAPP_PUBLISH_PROFILE_PROD:"
        echo "   Run: az webapp deployment list-publishing-profiles --name ${{ env.WEBAPP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --xml"
        echo ""
        echo "3. Add AZURE_STATIC_WEB_APPS_API_TOKEN_PROD:"
        echo "   Run: az staticwebapp secrets list --name ${{ env.STATIC_APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query 'properties.apiKey' -o tsv"
        echo ""
        echo "4. Update frontend/src/environments/environment.prod.ts:"
        echo "   apiUrl: '$BACKEND_URL/api'"
        echo ""
        echo "5. Run 'Deploy Backend to Azure' workflow"
        echo "6. Run 'Deploy Frontend to Azure' workflow"
        echo "=========================================="
        echo ""
        echo "üí∞ Monthly Cost: ~$18 USD"
        echo "üåç Location: ${{ github.event.inputs.location }}"
        echo "=========================================="
